<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet"
  />

  <title>Database</title>
  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
    }

    .header {
      background: linear-gradient(to right, #a1f0ff, #00d4b3);
      padding: 20px 0;
      text-align: center;
      position: relative;
    }

    .header h1 {
      color: black;
      margin: 0;
    }

    .header img.left-logo {
      position: absolute;
      top: 10px;
      left: 10px;
      height: 60px;
    }

    .header img.right-logo {
      position: absolute;
      top: 10px;
      right: 10px;
      height: 60px;
    }

    .toolbar {
      background-color: #333;
      padding: 10px 0;
      text-align: center;
    }

    .toolbar a {
      color: white;
      text-decoration: none;
      margin: 0 10px;
      padding: 8px 16px;
      font-weight: bold;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .toolbar a:hover {
      background-color: #00e0e0;
    }

    .query-section {
      padding: 20px;
      text-align: center;
      background-color: #f4f4f4;
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .query-section textarea {
      width: 80%;
      padding: 10px;
      font-size: 16px;
      margin-top: 10px;
      height: 150px;
      resize: none;
    }

    .query-section button {
      padding: 10px 20px;
      font-size: 16px;
      background-color: #333;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 10px;
    }

    .query-section button:hover {
      background-color: #00e0e0;
    }

    .query-results {
      margin: 30px auto;
      width: 90%;
      text-align: center;
    }

    .query-results table {
      border-collapse: collapse;
      margin: auto;
      width: 100%;
    }

    .query-results th,
    .query-results td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
    }

    .query-results th {
      background-color: #f4f4f4;
    }

    .csv-tables {
      margin-top: 40px;
    }

    .csv-tables .table-container {
      margin: 20px 0;
      text-align: center;
    }

    .csv-tables table {
      width: 80%;
      margin: 0 auto;
      border-collapse: collapse;
    }

    .csv-tables th,
    .csv-tables td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
    }
  </style>
</head>
<body>
  <div class="header">
    <img
      class="left-logo"
      src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fc/Valorant_logo_-_pink_color_version.svg/1280px-Valorant_logo_-_pink_color_version.svg.png"
    />
    <img
      class="right-logo"
      src="https://www.uwb.edu/wp-content/uploads/2023/06/stacked-w-uw-bothell-10.png"
    />
    <h1>Database</h1>
  </div>

  <div class="toolbar">
    <a href="about.html">About</a>
    <a href="index.html">Home</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="database.html">Database</a>
    <a
      href="https://pbs.twimg.com/media/GV1VL3jbcAAPfGc?format=jpg&name=large"
      target="_blank"
      >Full Bracket</a
    >
  </div>

  <!-- Query Section -->
  <div class="query-section">
    <h2>Query the Database:</h2>
    <textarea id="sql-query" placeholder="Enter your SQL query here"></textarea>
    <button onclick="submitQuery()">Submit Query</button>
  </div>

  <!-- Query Results -->
  <div id="query-results" class="query-results"></div>

  <!-- CSV Tables Section -->
  <div class="csv-tables">
    <div class="table-container">
      <h2>players_stats.csv</h2>
      <div id="players-table"></div>
    </div>

    <div class="table-container">
      <h2>maps_scores.csv</h2>
      <div id="maps-table"></div>
    </div>
  </div>

  <!-- Load PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    // Load first 10 rows of each CSV
    function loadCSV(file, targetId) {
      Papa.parse(file, {
        download: true,
        header: true,
        complete({ data }) {
          const slice = data.slice(0, 10);
          if (!slice.length) return;
          const headers = Object.keys(slice[0]);
          let html = '<table><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
          slice.forEach(row => {
            html += '<tr>' + headers.map(h => `<td>${row[h] ?? ''}</td>`).join('') + '</tr>';
          });
          html += '</table>';
          document.getElementById(targetId).innerHTML = html;
        }
      });
    }

    loadCSV('players_stats.csv', 'players-table');
    loadCSV('maps_scores.csv', 'maps-table');

    // Submit SQL query to your server
    async function submitQuery() {
      const query = document.getElementById('sql-query').value.trim();
      if (!query) {
        alert('Please enter a SQL statement.');
        return;
      }

      try {
        const response = await fetch('/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ statement: query })
        });
        const data = await response.json();
        if (!response.ok) {
          throw new Error(data?.error || 'Unknown error');
        }
        displayResults(data);
      } catch (err) {
        console.error(err);
        document.getElementById('query-results').innerHTML = `
          <p style="color: red;"><strong>Error:</strong> ${err.message}</p>
        `;
      }
    }

    // Render results (objects or strings)
    function displayResults(data) {
      const container = document.getElementById('query-results');

      if (!Array.isArray(data) || !data.length) {
        container.innerHTML = '<p>No results found.</p>';
        return;
      }

      // Distinct-values endpoint returns array of strings
      if (typeof data[0] === 'string') {
        let html = '<table><tr><th>Value</th></tr>';
        data.forEach(v => {
          html += `<tr><td>${v}</td></tr>`;
        });
        html += '</table>';
        container.innerHTML = html;
        return;
      }

      // Generic object rows
      const rows = data.filter(r => r && typeof r === 'object');
      if (!rows.length) {
        container.innerHTML = '<p>No valid rows.</p>';
        return;
      }

      const headers = Object.keys(rows[0]);
      let html = '<table><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
      rows.forEach(row => {
        html +=
          '<tr>' +
          headers.map(h => `<td>${row[h] ?? ''}</td>`).join('') +
          '</tr>';
      });
      html += '</table>';
      container.innerHTML = html;
    }
  </script>
</body>
</html>
