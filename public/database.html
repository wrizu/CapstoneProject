<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap"
    rel="stylesheet"
  />
  <title>Database</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
    }

    .header {
      background: linear-gradient(to right, #a1f0ff, #00d4b3);
      padding: 20px 0;
      text-align: center;
      position: relative;
    }

    .header h1 {
      color: black;
      margin: 0;
    }

    .header img.left-logo {
      position: absolute;
      top: 10px;
      left: 10px;
      height: 60px;
    }

    .header img.right-logo {
      position: absolute;
      top: 10px;
      right: 10px;
      height: 60px;
    }

    .toolbar {
      background-color: #333;
      padding: 10px 0;
      text-align: center;
    }

    .toolbar a {
      color: white;
      text-decoration: none;
      margin: 0 10px;
      padding: 8px 16px;
      font-weight: bold;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .toolbar a:hover {
      background-color: #00e0e0;
    }

    .query-section {
      padding: 20px;
      text-align: center;
      background-color: #f4f4f4;
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .query-section input,
    .query-section button {
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
      margin-bottom: 10px;
    }

    .query-section button {
      background-color: #333;
      color: white;
      border: none;
      cursor: pointer;
    }

    .query-section button:hover {
      background-color: #00e0e0;
    }

    .query-results {
      margin: 20px auto;
      width: 90%;
      text-align: center;
    }

    .query-results table {
      border-collapse: collapse;
      margin: auto;
      width: 100%;
    }

    .query-results th,
    .query-results td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: left;
    }

    .query-results th {
      background-color: #f4f4f4;
    }

    .error-message {
      color: red;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="header">
    <img class="left-logo" src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/fc/Valorant_logo_-_pink_color_version.svg/1280px-Valorant_logo_-_pink_color_version.svg.png" />
    <img class="right-logo" src="https://www.uwb.edu/wp-content/uploads/2023/06/stacked-w-uw-bothell-10.png" />
    <h1>Database</h1>
  </div>

  <div class="toolbar">
    <a href="about.html">About</a>
    <a href="index.html">Home</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="database.html">Database</a>
    <a href="https://pbs.twimg.com/media/GV1VL3jbcAAPfGc?format=jpg&name=large" target="_blank">Full Bracket</a>
  </div>

  <div class="query-section">
    <h2>Filter the Database:</h2>
    <input type="text" id="Tournament" placeholder="Enter Tournament (e.g., VALORANT Champions 2024)">
    <input type="text" id="Agents" placeholder="Enter Agent (e.g., Jett)">
    <input type="text" id="Player" placeholder="Enter Player Name">
    <input type="text" id="Teams" placeholder="Enter Team Name">
    <input type="text" id="KD" placeholder="Enter KD comparison (e.g., > 1.5)">
    <button onclick="submitQuery()">Submit Query</button>
  </div>

  <div id="query-results" class="query-results"></div>

  <div id="players-stats">
    <h3>Players Stats</h3>
    <div id="players-results"></div>
  </div>

  <div id="maps-scores">
    <h3>Maps Scores</h3>
    <div id="maps-results"></div>
  </div>

  <script>
    async function submitQuery() {
      const tournament = document.getElementById('Tournament').value.trim();
      const agent = document.getElementById('Agents').value.trim();
      const player = document.getElementById('Player').value.trim();
      const teams = document.getElementById('Teams').value.trim();
      const kd = document.getElementById('KD').value.trim();

      if (!tournament && !agent && !player && !teams && !kd) {
        alert('Please enter at least one filter (Tournament, Agent, Player, Teams, or KD).');
        return;
      }

      const filters = {};
      if (tournament) filters.tournament = tournament;
      if (agent) filters.agent = agent;
      if (player) filters.player = player;
      if (teams) filters.teams = teams;

      if (kd) {
        const validPattern = /^(>=|<=|<>|>|<|=)?\s*\d+(\.\d+)?$/;
        if (!validPattern.test(kd)) {
          alert('Invalid KD format. Use operators like >, <, >=, <=, = followed by a number (e.g., > 1.2)');
          return;
        }

        filters.kd = kd; // Send full string (operator + value) to server
      }

      try {
        const response = await fetch('/api/query', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(filters),
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data?.error || 'Unknown error');
        displayResults(data);
      } catch (err) {
        console.error(err);
        document.getElementById('query-results').innerHTML = `
          <p class="error-message"><strong>Error:</strong> ${err.message}</p>
        `;
      }
    }

    function displayResults(data) {
      const container = document.getElementById('query-results');

      if (!Array.isArray(data) || !data.length) {
        container.innerHTML = '<p>No results found.</p>';
        return;
      }

      const headers = Object.keys(data[0]);
      let html = '<table><tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
      data.forEach(row => {
        html += '<tr>' + headers.map(h => `<td>${row[h] ?? ''}</td>`).join('') + '</tr>';
      });
      html += '</table>';
      container.innerHTML = html;
    }

    function loadCSV(event) {
      const file = event.target.files[0];
      if (!file) return;

      Papa.parse(file, {
        complete: function(results) {
          const resultsElement = document.getElementById('results');
          if (resultsElement) {
            resultsElement.innerHTML = '<pre>' + JSON.stringify(results, null, 2) + '</pre>';
          } else {
            console.error('The results element is missing.');
          }
        },
        header: true,
        skipEmptyLines: true
      });
    }
  </script>
</body>
</html>
